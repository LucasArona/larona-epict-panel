{"version":3,"sources":["../src/epict_ctrl.js"],"names":["MetricsPanelCtrl","TimeSeries","_","scaleQuantize","panelDefaults","bgColor","boxes","EpictCtrl","$scope","$injector","defaultsDeep","panel","events","on","onInitEditMode","bind","onPanelTeardown","onDataReceived","onDataSnapshotLoad","render","boxesRawValues","boxesTexts","addEditorTab","processedBgURL","templateSrv","replace","bgURL","scopedVars","self","numberOfBoxes","scope","ctrl","length","i","box","URL","processedURL","usingThresholds","parseInt","thresholds","split","color","colorLow","blinkLow","isBlinking","colorHigh","blinkHigh","colorMedium","panelData","series","map","seriesHandler","size","wantedSerie","filter","oneSerie","alias","serie","datapoints","nf","Intl","NumberFormat","numberBeforeFormatting","toFixed","decimal","push","formattedNumber","format","console","log","snapshotData","seriesData","target","flotpairs","getFlotPairs","nullPointMode","text","xpos","ypos","angle","fontsize","prefixSize","suffixSize","hasOrb","orbSize","orbHideText","orbLocation","$index","Object","assign","splice","refresh","e","ctrlKey","alert","offsetX","offsetY","elem","$panelContainer","find","css","templateUrl"],"mappings":"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","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport TimeSeries from 'app/core/time_series2';\nimport _ from 'lodash';\nimport { scaleQuantize } from 'd3';\n\nconst panelDefaults = {\n  bgColor: null,\n  boxes: []\n};\n\nexport class EpictCtrl extends MetricsPanelCtrl {\n  \n  constructor($scope, $injector) {\n    super($scope, $injector);\n    _.defaultsDeep(this.panel, panelDefaults);\n\n   \n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n    this.events.on('panel-initialized', this.render.bind(this));\n    this.events.on('render',this.render.bind(this));\n    this.boxesRawValues=[];\n    this.boxesTexts=[];\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/larona-epict-panel/editor.html', 2);\n  }\n\n  onPanelTeardown() {\n  }\n\n  render(){\n\t  this.processedBgURL=this.templateSrv.replace(this.panel.bgURL, this.panel.scopedVars);\n    var self=this;\n    var numberOfBoxes=this.scope.ctrl.panel.boxes.length;\n    for(var i=0; i<numberOfBoxes;i++){\n      var box=this.scope.ctrl.panel.boxes[i];\n      if(box.URL){\n        box.processedURL=self.templateSrv.replace(box.URL, self.panel.scopedVars)\n      }\n      if(box.usingThresholds==true){\n        if(this.boxesRawValues[i] <=parseInt(box.thresholds.split(',')[0])){\n          box.color=box.colorLow;\n          if(box.blinkLow){\n            box.isBlinking=true\n          }else{\n            box.isBlinking=false;\n          }\n        }else if(this.boxesRawValues[i] >=parseInt(box.thresholds.split(',')[1])){\n          box.color=box.colorHigh;\n          if(box.blinkHigh){\n            box.isBlinking=true\n          }else{\n            box.isBlinking=false;\n          }\n        }else{\n          box.color=box.colorMedium\n          box.isBlinking=false;\n        }\n      }else{\n        box.isBlinking=false;\n      }\n    }\n  }\n\n  onDataReceived(panelData) {\n    var self=this;\n    // console.log(panelData);\n    this.series = panelData.map(this.seriesHandler.bind(this));\n    // console.log(this.series);\n    this.boxesRawValues=[]; //Store values in this array instead of boxes, otherwise the values will be persisted in grafana db and trigger an \"unsaved changes warning\" everytime\n\n    var size=this.panel.boxes.length;\n    this.boxesTexts=[];\n    for(var i=0; i<size; i++){\n      var box=this.panel.boxes[i];\n      var wantedSerie = this.series.filter(function (oneSerie) {\n        return oneSerie.alias == self.templateSrv.replace(box.serie, self.panel.scopedVars);\n      });\n      if(wantedSerie != null && wantedSerie[0]!=null && wantedSerie[0].datapoints.length!=0)\n      {\n        if(wantedSerie[0].datapoints[wantedSerie[0].datapoints.length - 1][0]!=null){\n          var nf = new Intl.NumberFormat();\n          var numberBeforeFormatting=wantedSerie[0].datapoints[wantedSerie[0].datapoints.length - 1][0].toFixed(box.decimal);\n          this.boxesRawValues.push(wantedSerie[0].datapoints[wantedSerie[0].datapoints.length - 1][0]); //Used to determine the color if the Threshold is enabled\n          var formattedNumber = nf.format(numberBeforeFormatting);\n          this.boxesTexts.push(formattedNumber);\n        }else{\n          this.boxesRawValues.push(null);\n          this.boxesTexts.push(\"-\")\n        }\n      }else{\n        this.boxesRawValues.push(null);\n        this.boxesTexts.push(\"N/A\")\n      }\n    }\n    console.log(this.boxesRawValues);\n    console.log(this.boxesTexts);\n    this.render();\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData);\n  }\n\n  seriesHandler(seriesData) {\n    const series = new TimeSeries({\n      datapoints: seriesData.datapoints || [],\n      alias: seriesData.target,\n    });\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    \n    return series;\n  }\n\n  addBox(){\n    this.panel.boxes.push({serie:\"A-series\",text:\"N/A\",xpos:0,ypos:0,angle:0,fontsize:12,prefixSize:10,suffixSize:10,color:\"#000\",decimal:1,usingThresholds:false,thresholds:'20,60',colorLow:\"#0f0\",colorMedium:\"#fa1\",colorHigh:\"#f00\", hasOrb:false, orbSize:\"10\", orbHideText:false, orbLocation: \"Left\"});\n    \n    console.log(this.panel.boxes);\n  }\n  cloneBox($index){\n    this.panel.boxes.push(Object.assign({}, this.panel.boxes[$index]));\n  }\n  deleteBox($index){\n     this.panel.boxes.splice($index,1);\n     this.refresh();\n  }\nclicktest(e){\n  if(e.ctrlKey){\n    alert(\"X:\"+e.offsetX+\" Y:\"+e.offsetY);\n  }\n}\n\n  link(scope, elem) {\n    this.events.on('render', () => {\n      const $panelContainer = elem.find('.panel-container');\n\n      if (this.panel.bgColor) {\n        $panelContainer.css('background-color', this.panel.bgColor);\n      } else {\n        $panelContainer.css('background-color', '');\n      }\n    });\n  }\n}\n\nEpictCtrl.templateUrl = 'module.html';\n"],"file":"epict_ctrl.js"}